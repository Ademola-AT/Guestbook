<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.91.2" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Secrets &middot; Go CDK</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Source+Code+Pro|Work+Sans:400,700">
  <link type="text/css" rel="stylesheet" href="/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="/css/style.css">
  <link rel="shortcut icon" href="/favicon-32x32.png">
  
</head>
<body>
  <div class="PageLayout">
    <header class="PageHeader">
      <a href="https://gocloud.dev/"><h1 class="PageLogo"><img class="PageLogo-image" src="/go-cdk-logo-white.png" alt="Go CDK"></h1></a>
    </header>
    <main class="MainContent">
      <div class="MainContent-bounds"><h1>Secrets</h1>

<nav class="PageTOC">
  <div class="PageTOC-heading">In this article</div>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#opening">Opening a SecretsKeeper</a></li>
    <li><a href="#using">Using a SecretsKeeper</a>
      <ul>
        <li><a href="#encrypt">Encrypting Data</a></li>
        <li><a href="#decrypt">Decrypting Data</a></li>
        <li><a href="#large-messages">Large Messages</a></li>
        <li><a href="#runtimevar">Keep Secrets in Configuration</a></li>
      </ul>
    </li>
    <li><a href="#other-usage-samples">Other Usage Samples</a></li>
    <li><a href="#services">Supported Services</a>
      <ul>
        <li><a href="#gcp">Google Cloud Key Management Service</a></li>
        <li><a href="#aws">AWS Key Management Service</a></li>
        <li><a href="#azure">Azure KeyVault</a></li>
        <li><a href="#vault">HashiCorp Vault</a></li>
        <li><a href="#local">Local Secrets</a></li>
      </ul>
    </li>
  </ul>
</nav>
</nav>

<p>The <a href="https://godoc.org/gocloud.dev/secrets"><code>secrets</code> package</a> provides access to key management services in a
portable way. This guide shows how to work with secrets in the Go CDK.</p>
<p>Cloud applications frequently need to store sensitive information like web
API credentials or encryption keys in a medium that is not fully secure. For
example, an application that interacts with GitHub needs to store its OAuth2
client secret and use it when obtaining end-user credentials. If this
information was compromised, it could allow someone else to impersonate the
application. In order to keep such information secret and secure, you can
encrypt the data, but then you need to worry about rotating the encryption
keys and distributing them securely to all of your application servers.
Most Cloud providers include a key management service to perform these tasks,
usually with hardware-level security and audit logging.</p>
<p>The <a href="https://godoc.org/gocloud.dev/secrets"><code>secrets</code> package</a> supports encryption and decryption operations.</p>
<p>Subpackages contain driver implementations of secrets for various services,
including Cloud and on-prem solutions. You can develop your application
locally using <a href="https://godoc.org/gocloud.dev/secrets/localsecrets"><code>localsecrets</code></a>, then deploy it to multiple Cloud providers with
minimal initialization reconfiguration.</p>
<h2 id="opening"> Opening a SecretsKeeper<a class="anchor" href="#opening" aria-label="Link to Section">ðŸ”—</a></h2>
<p>The first step in working with your secrets is
to instantiate a portable <a href="https://godoc.org/gocloud.dev/secrets#Keeper"><code>*secrets.Keeper</code></a> for your service.</p>
<p>The easiest way to do so is to use <a href="https://godoc.org/gocloud.dev/secrets#OpenKeeper"><code>secrets.OpenKeeper</code></a> and a service-specific
URL pointing to the keeper, making sure you <a href="https://golang.org/doc/effective_go.html#blank_import">&ldquo;blank import&rdquo;</a> the driver
package to link it in.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;gocloud.dev/secrets&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;gocloud.dev/secrets/&lt;driver&gt;&#34;</span>
<span class="p">)</span>
<span class="o">...</span>
<span class="nx">keeper</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">secrets</span><span class="p">.</span><span class="nf">OpenKeeper</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="s">&#34;&lt;driver-url&gt;&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;could not open keeper: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">keeper</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
<span class="c1">// keeper is a *secrets.Keeper; see usage below
</span><span class="c1"></span><span class="o">...</span>
</code></pre></div><p>See <a href="https://gocloud.dev/concepts/urls/">Concepts: URLs</a> for general background and the <a href="#services">guide below</a>
for URL usage for each supported service.</p>
<p>Alternatively, if you need
fine-grained control over the connection settings, you can call the constructor
function in the driver package directly (like <code>awskms.OpenKeeper</code>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="s">&#34;gocloud.dev/secrets/&lt;driver&gt;&#34;</span>
<span class="o">...</span>
<span class="nx">keeper</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="p">&lt;</span><span class="nx">driver</span><span class="p">&gt;.</span><span class="nf">OpenKeeper</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="o">...</span>
</code></pre></div><p>You may find the <a href="http://github.com/google/wire"><code>wire</code> package</a> useful for managing your initialization code
when switching between different backing services.</p>
<p>See the <a href="#services">guide below</a> for constructor usage for each supported service.</p>
<h2 id="using"> Using a SecretsKeeper<a class="anchor" href="#using" aria-label="Link to Section">ðŸ”—</a></h2>
<p>Once you have <a href="#opening">opened a secrets keeper</a> for the secrets provider you want,
you can encrypt and decrypt small messages using the keeper.</p>
<h3 id="encrypt"> Encrypting Data<a class="anchor" href="#encrypt" aria-label="Link to Section">ðŸ”—</a></h3>
<p>To encrypt data with a keeper, you call <code>Encrypt</code> with the byte slice you
want to encrypt.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">plainText</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;Secrets secrets...&#34;</span><span class="p">)</span>
<span class="nx">cipherText</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">keeper</span><span class="p">.</span><span class="nf">Encrypt</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">plainText</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="decrypt"> Decrypting Data<a class="anchor" href="#decrypt" aria-label="Link to Section">ðŸ”—</a></h3>
<p>To decrypt data with a keeper, you call <code>Decrypt</code> with the byte slice you
want to decrypt. This should be data that you obtained from a previous call
to <code>Encrypt</code> with a keeper that uses the same secret material (e.g. two AWS
KMS keepers created with the same customer master key ID). The <code>Decrypt</code>
method will return an error if the input data is corrupted.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">cipherText</span> <span class="p">[]</span><span class="kt">byte</span> <span class="c1">// obtained from elsewhere and random-looking
</span><span class="c1"></span><span class="nx">plainText</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">keeper</span><span class="p">.</span><span class="nf">Decrypt</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cipherText</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="large-messages"> Large Messages<a class="anchor" href="#large-messages" aria-label="Link to Section">ðŸ”—</a></h3>
<p>The secrets keeper API is designed to work with small messages (i.e. &lt;10 KiB
in length.) Cloud key management services are high latency; using them for
encrypting or decrypting large amounts of data is prohibitively slow (and in
some providers not permitted). If you need your application to encrypt or
decrypt large amounts of data, you should:</p>
<ol>
<li>Generate a key for the encryption algorithm (16KiB chunks with
<a href="https://godoc.org/golang.org/x/crypto/nacl/secretbox"><code>secretbox</code></a> is a reasonable approach).</li>
<li>Encrypt the key with secret keeper.</li>
<li>Store the encrypted key somewhere accessible to the application.</li>
</ol>
<p>When your application needs to encrypt or decrypt a large message:</p>
<ol>
<li>Decrypt the key from storage using the secret keeper</li>
<li>Use the decrypted key to encrypt or decrypt the message inside your
application.</li>
</ol>
<h3 id="runtimevar"> Keep Secrets in Configuration<a class="anchor" href="#runtimevar" aria-label="Link to Section">ðŸ”—</a></h3>
<p>Once you have <a href="#opening">opened a secrets keeper</a> for the secrets provider you want,
you can use a secrets keeper to access sensitive configuration stored in an
encrypted <code>runtimevar</code>.</p>
<p>First, you create a <a href="https://godoc.org/gocloud.dev/runtimevar#Decoder"><code>*runtimevar.Decoder</code></a> configured to use your secrets
keeper using <a href="https://godoc.org/gocloud.dev/runtimevar#DecryptDecode"><code>runtimevar.DecryptDecode</code></a>. In this example, we assume the
data is a plain string, but the configuration could be a more structured
type.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">decodeFunc</span> <span class="o">:=</span> <span class="nx">runtimevar</span><span class="p">.</span><span class="nf">DecryptDecode</span><span class="p">(</span><span class="nx">keeper</span><span class="p">,</span> <span class="nx">runtimevar</span><span class="p">.</span><span class="nx">StringDecode</span><span class="p">)</span>
<span class="nx">decoder</span> <span class="o">:=</span> <span class="nx">runtimevar</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">decodeFunc</span><span class="p">)</span>
</code></pre></div>
<p>Then you can pass the decoder to the runtime configuration provider of your
choice. See the <a href="https://gocloud.dev/howto/runtimevar/">Runtime Configuration How-To Guide</a> for more on how to set up
runtime configuration.</p>
<h2 id="other-usage-samples"> Other Usage Samples<a class="anchor" href="#other-usage-samples" aria-label="Link to Section">ðŸ”—</a></h2>
<ul>
<li><a href="https://github.com/google/go-cloud/tree/master/samples/gocdk-secrets">CLI Sample</a></li>
<li><a href="https://godoc.org/gocloud.dev/secrets#example-package">Secrets package examples</a></li>
</ul>
<h2 id="services"> Supported Services<a class="anchor" href="#services" aria-label="Link to Section">ðŸ”—</a></h2>
<h3 id="gcp"> Google Cloud Key Management Service<a class="anchor" href="#gcp" aria-label="Link to Section">ðŸ”—</a></h3>
<p>The Go CDK can use keys from Google Cloud Platform&rsquo;s <a href="https://cloud.google.com/kms/">Key Management
Service</a> (GCP KMS) to keep information secret. GCP KMS URLs are
similar to <a href="https://cloud.google.com/kms/docs/object-hierarchy#key">key resource IDs</a>.</p>
<p><code>secrets.OpenKeeper</code> will use Application Default Credentials; if you have
authenticated via <a href="https://cloud.google.com/sdk/gcloud/reference/auth/application-default/login"><code>gcloud auth application-default login</code></a>, it will use those credentials. See
<a href="https://cloud.google.com/docs/authentication/production">Application Default Credentials</a> to learn about authentication
alternatives, including using environment variables.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/secrets&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;gocloud.dev/secrets/gcpkms&#34;</span>
<span class="p">)</span>

<span class="nx">keeper</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">secrets</span><span class="p">.</span><span class="nf">OpenKeeper</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span>
	<span class="s">&#34;gcpkms://projects/MYPROJECT/&#34;</span><span class="o">+</span>
		<span class="s">&#34;locations/MYLOCATION/&#34;</span><span class="o">+</span>
		<span class="s">&#34;keyRings/MYKEYRING/&#34;</span><span class="o">+</span>
		<span class="s">&#34;cryptoKeys/MYKEY&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">keeper</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</code></pre></div>
<h4 id="gcp-ctor"> GCP Constructor<a class="anchor" href="#gcp-ctor" aria-label="Link to Section">ðŸ”—</a></h4>
<p>The <a href="https://godoc.org/gocloud.dev/secrets/gcpkms#OpenKeeper"><code>gcpkms.OpenKeeper</code></a> constructor opens a GCP KMS key. You must first
obtain <a href="https://cloud.google.com/docs/authentication/production">GCP credentials</a> and then create a gRPC connection to GCP KMS.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/secrets/gcpkms&#34;</span>
<span class="p">)</span>

<span class="c1">// Get a client to use with the KMS API.
</span><span class="c1"></span><span class="nx">client</span><span class="p">,</span> <span class="nx">done</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gcpkms</span><span class="p">.</span><span class="nf">Dial</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="c1">// Close the connection when done.
</span><span class="c1"></span><span class="k">defer</span> <span class="nf">done</span><span class="p">()</span>

<span class="c1">// You can also use gcpkms.KeyResourceID to construct this string.
</span><span class="c1"></span><span class="kd">const</span> <span class="nx">keyID</span> <span class="p">=</span> <span class="s">&#34;projects/MYPROJECT/&#34;</span> <span class="o">+</span>
	<span class="s">&#34;locations/MYLOCATION/&#34;</span> <span class="o">+</span>
	<span class="s">&#34;keyRings/MYKEYRING/&#34;</span> <span class="o">+</span>
	<span class="s">&#34;cryptoKeys/MYKEY&#34;</span>

<span class="c1">// Construct a *secrets.Keeper.
</span><span class="c1"></span><span class="nx">keeper</span> <span class="o">:=</span> <span class="nx">gcpkms</span><span class="p">.</span><span class="nf">OpenKeeper</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">keyID</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">keeper</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</code></pre></div>
<h3 id="aws"> AWS Key Management Service<a class="anchor" href="#aws" aria-label="Link to Section">ðŸ”—</a></h3>
<p>The Go CDK can use customer master keys from Amazon Web Service&rsquo;s <a href="https://aws.amazon.com/kms/">Key
Management Service</a> (AWS KMS) to keep information secret. AWS KMS
URLs can use the key&rsquo;s ID, alias, or Amazon Resource Name (ARN) to identify
the key. You should specify the <code>region</code> query parameter to ensure your
application connects to the correct region.</p>
<p>If you set the &ldquo;awssdk=v1&rdquo; query parameter,
<code>secrets.OpenKeeper</code> will create a default AWS Session with the
<code>SharedConfigEnable</code> option enabled; if you have authenticated with the AWS CLI,
it will use those credentials. See <a href="https://docs.aws.amazon.com/sdk-for-go/api/aws/session/">AWS Session</a> to learn about authentication
alternatives, including using environment variables.</p>
<p>If you set the &ldquo;awssdk=v2&rdquo; query parameter, it will instead create an AWS
Config based on the AWS SDK V2; see <a href="https://aws.github.io/aws-sdk-go-v2/docs/configuring-sdk/">AWS V2 Config</a> to learn more.</p>
<p>If no &ldquo;awssdk&rdquo; query parameter is set, Go CDK will use a default (currently V1).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/secrets&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;gocloud.dev/secrets/awskms&#34;</span>
<span class="p">)</span>

<span class="c1">// Use one of the following:
</span><span class="c1"></span>
<span class="c1">// 1. By ID.
</span><span class="c1"></span><span class="nx">keeperByID</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">secrets</span><span class="p">.</span><span class="nf">OpenKeeper</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span>
	<span class="s">&#34;awskms://1234abcd-12ab-34cd-56ef-1234567890ab?region=us-east-1&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">keeperByID</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="c1">// 2. By alias.
</span><span class="c1"></span><span class="nx">keeperByAlias</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">secrets</span><span class="p">.</span><span class="nf">OpenKeeper</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span>
	<span class="s">&#34;awskms://alias/ExampleAlias?region=us-east-1&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">keeperByAlias</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="c1">// 3. By ARN.
</span><span class="c1"></span><span class="kd">const</span> <span class="nx">arn</span> <span class="p">=</span> <span class="s">&#34;arn:aws:kms:us-east-1:111122223333:key/&#34;</span> <span class="o">+</span>
	<span class="s">&#34;1234abcd-12ab-34bc-56ef-1234567890ab&#34;</span>
<span class="nx">keeperByARN</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">secrets</span><span class="p">.</span><span class="nf">OpenKeeper</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span>
	<span class="s">&#34;awskms://&#34;</span><span class="o">+</span><span class="nx">arn</span><span class="o">+</span><span class="s">&#34;?region=us-east-1&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">keeperByARN</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="c1">// Use &#34;awssdk=v1&#34; or &#34;v2&#34; to force a specific AWS SDK version.
</span><span class="c1"></span><span class="nx">keeperUsingV2</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">secrets</span><span class="p">.</span><span class="nf">OpenKeeper</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span>
	<span class="s">&#34;awskms://1234abcd-12ab-34cd-56ef-1234567890ab?region=us-east-1&amp;awssdk=v2&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">keeperUsingV2</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</code></pre></div>
<h4 id="aws-ctor"> AWS Constructor<a class="anchor" href="#aws-ctor" aria-label="Link to Section">ðŸ”—</a></h4>
<p>The <a href="https://godoc.org/gocloud.dev/secrets/awskms#OpenKeeper"><code>awskms.OpenKeeper</code></a> constructor opens a customer master key. You must
first create an <a href="https://docs.aws.amazon.com/sdk-for-go/api/aws/session/">AWS session</a> with the same region as your key and then
connect to KMS:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;github.com/aws/aws-sdk-go/aws/session&#34;</span>
	<span class="s">&#34;gocloud.dev/secrets/awskms&#34;</span>
<span class="p">)</span>

<span class="c1">// Establish an AWS session.
</span><span class="c1">// See https://docs.aws.amazon.com/sdk-for-go/api/aws/session/ for more info.
</span><span class="c1"></span><span class="nx">sess</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">session</span><span class="p">.</span><span class="nf">NewSession</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// Get a client to use with the KMS API.
</span><span class="c1"></span><span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">awskms</span><span class="p">.</span><span class="nf">Dial</span><span class="p">(</span><span class="nx">sess</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// Construct a *secrets.Keeper.
</span><span class="c1"></span><span class="nx">keeper</span> <span class="o">:=</span> <span class="nx">awskms</span><span class="p">.</span><span class="nf">OpenKeeper</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="s">&#34;alias/test-secrets&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">keeper</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</code></pre></div>
<p><a href="https://godoc.org/gocloud.dev/secrets/awskms#OpenKeeperV2"><code>awskms.OpenKeeperV2</code></a> is similar but uses the AWS SDK V2.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="nx">awsv2cfg</span> <span class="s">&#34;github.com/aws/aws-sdk-go-v2/config&#34;</span>
	<span class="s">&#34;gocloud.dev/secrets/awskms&#34;</span>
<span class="p">)</span>

<span class="c1">// Establish a AWS V2 Config.
</span><span class="c1">// See https://aws.github.io/aws-sdk-go-v2/docs/configuring-sdk/ for more info.
</span><span class="c1"></span><span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
<span class="nx">cfg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">awsv2cfg</span><span class="p">.</span><span class="nf">LoadDefaultConfig</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// Get a client to use with the KMS API.
</span><span class="c1"></span><span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">awskms</span><span class="p">.</span><span class="nf">DialV2</span><span class="p">(</span><span class="nx">cfg</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// Construct a *secrets.Keeper.
</span><span class="c1"></span><span class="nx">keeper</span> <span class="o">:=</span> <span class="nx">awskms</span><span class="p">.</span><span class="nf">OpenKeeperV2</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="s">&#34;alias/test-secrets&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">keeper</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</code></pre></div>
<h3 id="azure"> Azure KeyVault<a class="anchor" href="#azure" aria-label="Link to Section">ðŸ”—</a></h3>
<p>The Go CDK can use keys from <a href="https://azure.microsoft.com/en-us/services/key-vault/">Azure KeyVault</a> to keep information secret.
<code>secrets.OpenKeeper</code> will use <a href="https://docs.microsoft.com/en-us/go/azure/azure-sdk-go-authorization#use-environment-based-authentication">default credentials from the environment</a>, unless you set the environment variable
<code>AZURE_KEYVAULT_AUTH_VIA_CLI</code> to <code>true</code>, in which case it will use
credentials from the <code>az</code> command line.</p>
<p>Azure KeyVault URLs are based on the <a href="https://docs.microsoft.com/en-us/azure/key-vault/about-keys-secrets-and-certificates">Azure Key object identifer</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/secrets&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;gocloud.dev/secrets/azurekeyvault&#34;</span>
<span class="p">)</span>

<span class="c1">// The &#34;azurekeyvault&#34; URL scheme is replaced with &#34;https&#34; to construct an Azure
</span><span class="c1">// Key Vault keyID, as described in https://docs.microsoft.com/en-us/azure/key-vault/about-keys-secrets-and-certificates.
</span><span class="c1">// You can add an optional &#34;/{key-version}&#34; to the path to use a specific
</span><span class="c1">// version of the key; it defaults to the latest version.
</span><span class="c1"></span><span class="nx">keeper</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">secrets</span><span class="p">.</span><span class="nf">OpenKeeper</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;azurekeyvault://mykeyvaultname.vault.azure.net/keys/mykeyname&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">keeper</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</code></pre></div>
<h4 id="azure-ctor"> Azure Constructor<a class="anchor" href="#azure-ctor" aria-label="Link to Section">ðŸ”—</a></h4>
<p>The <a href="https://godoc.org/gocloud.dev/secrets/azurekeyvault#OpenKeeper"><code>azurekeyvault.OpenKeeper</code></a> constructor opens an Azure KeyVault key.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="s">&#34;gocloud.dev/secrets/azurekeyvault&#34;</span>

<span class="c1">// Makes a client to use with the Azure KeyVault API, using default
</span><span class="c1">// authorization from the environment.
</span><span class="c1"></span><span class="nx">clientMaker</span> <span class="o">:=</span> <span class="nx">azurekeyvault</span><span class="p">.</span><span class="nx">DefaultClientMaker</span>

<span class="c1">// Construct a *secrets.Keeper.
</span><span class="c1"></span><span class="nx">keeper</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">azurekeyvault</span><span class="p">.</span><span class="nf">OpenKeeper</span><span class="p">(</span><span class="nx">clientMaker</span><span class="p">,</span> <span class="s">&#34;https://mykeyvaultname.vault.azure.net/keys/mykeyname&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">keeper</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</code></pre></div>
<h3 id="vault"> HashiCorp Vault<a class="anchor" href="#vault" aria-label="Link to Section">ðŸ”—</a></h3>
<p>The Go CDK can use the <a href="https://www.vaultproject.io/docs/secrets/transit/index.html">transit secrets engine</a> in <a href="https://www.vaultproject.io/">Vault</a> to keep
information secret. Vault URLs only specify the key ID. The Vault server
endpoint and authentication token are specified using the environment
variables <code>VAULT_SERVER_URL</code> and <code>VAULT_SERVER_TOKEN</code>, respectively.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/secrets&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;gocloud.dev/secrets/hashivault&#34;</span>
<span class="p">)</span>

<span class="nx">keeper</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">secrets</span><span class="p">.</span><span class="nf">OpenKeeper</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;hashivault://mykey&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">keeper</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</code></pre></div>
<h4 id="vault-ctor"> HashiCorp Vault Constructor<a class="anchor" href="#vault-ctor" aria-label="Link to Section">ðŸ”—</a></h4>
<p>The <a href="https://godoc.org/gocloud.dev/secrets/hashivault#OpenKeeper"><code>hashivault.OpenKeeper</code></a> constructor opens a transit secrets engine
key. You must first connect to your Vault instance.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;github.com/hashicorp/vault/api&#34;</span>
	<span class="s">&#34;gocloud.dev/secrets/hashivault&#34;</span>
<span class="p">)</span>

<span class="c1">// Get a client to use with the Vault API.
</span><span class="c1"></span><span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">hashivault</span><span class="p">.</span><span class="nf">Dial</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">hashivault</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
	<span class="nx">Token</span><span class="p">:</span> <span class="s">&#34;CLIENT_TOKEN&#34;</span><span class="p">,</span>
	<span class="nx">APIConfig</span><span class="p">:</span> <span class="nx">api</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
		<span class="nx">Address</span><span class="p">:</span> <span class="s">&#34;http://127.0.0.1:8200&#34;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// Construct a *secrets.Keeper.
</span><span class="c1"></span><span class="nx">keeper</span> <span class="o">:=</span> <span class="nx">hashivault</span><span class="p">.</span><span class="nf">OpenKeeper</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="s">&#34;my-key&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">keeper</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</code></pre></div>
<h3 id="local"> Local Secrets<a class="anchor" href="#local" aria-label="Link to Section">ðŸ”—</a></h3>
<p>The Go CDK can use local encryption for keeping secrets. Internally, it uses
the <a href="https://godoc.org/golang.org/x/crypto/nacl/secretbox">NaCl secret box</a> algorithm to perform encryption and authentication.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="s">&#34;gocloud.dev/secrets&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;gocloud.dev/secrets/localsecrets&#34;</span>
<span class="p">)</span>

<span class="c1">// Using &#34;base64key://&#34;, a new random key will be generated.
</span><span class="c1"></span><span class="nx">randomKeyKeeper</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">secrets</span><span class="p">.</span><span class="nf">OpenKeeper</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;base64key://&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">randomKeyKeeper</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="c1">// Otherwise, the URL hostname must be a base64-encoded key, of length 32 bytes when decoded.
</span><span class="c1">// Note that base64.URLEncode should be used, to avoid URL-unsafe characters.
</span><span class="c1"></span><span class="nx">savedKeyKeeper</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">secrets</span><span class="p">.</span><span class="nf">OpenKeeper</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;base64key://smGbjm71Nxd1Ig5FS0wj9SlbzAIrnolCz9bQQ6uAhl4=&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">savedKeyKeeper</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</code></pre></div>
<h4 id="local-ctor"> Local Secrets Constructor<a class="anchor" href="#local-ctor" aria-label="Link to Section">ðŸ”—</a></h4>
<p>The <a href="https://godoc.org/gocloud.dev/secrets/localsecrets#NewKeeper"><code>localsecrets.NewKeeper</code></a> constructor takes in its secret material as
a <code>[]byte</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="s">&#34;gocloud.dev/secrets/localsecrets&#34;</span>

<span class="nx">secretKey</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">localsecrets</span><span class="p">.</span><span class="nf">NewRandomKey</span><span class="p">()</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="nx">keeper</span> <span class="o">:=</span> <span class="nx">localsecrets</span><span class="p">.</span><span class="nf">NewKeeper</span><span class="p">(</span><span class="nx">secretKey</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">keeper</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</code></pre></div>
</div>
    </main>
    <nav class="Sidenav">
      <ul class="Sidenav-list">
        <li class="Sidenav-section">
          <a href="/" class="Sidenav-sectionLink">Home</a>
        </li>
        <li class="Sidenav-section">
          <a href="/tutorials/" class="Sidenav-sectionLink">Tutorials</a>
            <ul class="Sidenav-pageList">
              <li class="Sidenav-page">
                <a href="/tutorials/cli-uploader/" class="Sidenav-pageLink">Command-Line Uploader</a>
              </li>
              <li class="Sidenav-page">
                <a href="/tutorials/guestbook/" class="Sidenav-pageLink">Guestbook</a>
              </li>
              <li class="Sidenav-page">
                <a href="/tutorials/order/" class="Sidenav-pageLink">Order Processor</a>
              </li>
            </ul>
        </li>
        <li class="Sidenav-section">
          <a href="/howto/" class="Sidenav-sectionLink">How-To Guides</a>
            <ul class="Sidenav-pageList">
              <li class="Sidenav-page">
                <a href="/howto/blob/" class="Sidenav-pageLink">Blob</a>
              </li>
              <li class="Sidenav-page">
                <a href="/howto/docstore/" class="Sidenav-pageLink">Docstore</a>
              </li>
              <li class="Sidenav-page">
                <a href="/howto/sql/" class="Sidenav-pageLink">MySQL/PostgreSQL</a>
              </li>
              <li class="Sidenav-page">
                <a href="/howto/pubsub/" class="Sidenav-pageLink">Pub/Sub</a>
              </li>
              <li class="Sidenav-page">
                <a href="/howto/runtimevar/" class="Sidenav-pageLink">Runtime Configuration</a>
              </li>
              <li class="Sidenav-page">
                <a href="/howto/secrets/" class="Sidenav-pageLink">Secrets</a>
              </li>
              <li class="Sidenav-page">
                <a href="/howto/server/" class="Sidenav-pageLink">Server</a>
              </li>
            </ul>
        </li>
        <li class="Sidenav-section">
          <a href="/concepts/" class="Sidenav-sectionLink">Concepts</a>
            <ul class="Sidenav-pageList">
              <li class="Sidenav-page">
                <a href="/concepts/structure/" class="Sidenav-pageLink">Structuring Portable Code</a>
              </li>
              <li class="Sidenav-page">
                <a href="/concepts/urls/" class="Sidenav-pageLink">URLs</a>
              </li>
              <li class="Sidenav-page">
                <a href="/concepts/as/" class="Sidenav-pageLink">Using provider-specific APIs</a>
              </li>
            </ul>
        </li>
      </ul>
    </nav>
    <footer class="PageFooter">
      <nav>
        <ul class="FooterLinks">
          <li class="FooterLinks-item"><a href="https://github.com/google/go-cloud/" class="FooterLinks-link">GitHub</a></li>
          <li class="FooterLinks-item"><a href="https://github.com/google/go-cloud/issues" class="FooterLinks-link">Contact Team</a></li>
        </ul>
      </nav>

      <p class="PageFooter-paragraph">
        Copyright Â© 2018â€“2019 The Go Cloud Development Kit Authors.
        All content released under an <a href="https://github.com/google/go-cloud/blob/master/LICENSE" target="_blank" class="PageFooter-link">Apache 2.0 License</a>.
      </p>
      <p class="PageFooter-paragraph"><a href="https://github.com/google/go-cloud/edit/master/internal/website/content/howto/secrets/_index.md" class="PageFooter-link">Improve this page</a> on GitHub.</p>
    </footer>
  </div>
</body>
</html>
